\documentclass[../slides]{subfiles}


\newcommand{\ctreeone}{\subfile{01-ctree.tex}}
\newcommand{\ctreetwo}{%
    \begin{tikzpicture}[
        edge from parent path={(\tikzparentnode.south) -- ++(0,-1mm) -| (\tikzchildnode.north)},
        level distance=7mm,
        font=\small,
        sibling distance=10mm,
        anchor=center,
        every path/.style={line width=.2ex},
        every node/.style={text height=2.5mm},
        rounded corners=0
    ]
        \matrix (pos) [matrix of nodes, outer sep=0pt, inner sep=0pt, row sep=0pt, column sep=7pt, ampersand replacement=\&] {
            \strut A \& \strut hearing \& \strut is  \& \strut scheduled \& \strut on \& \strut the \& \strut issue \& \strut today \\};

        \node[above=35mm of pos, xshift=-5mm] {\nt{VP}}
        child { node[above=1mm of pos-1-3] {\nt{VBZ}}}
        child { node {\nt{VP}}
            child { node[above=1mm of pos-1-4] {\nt{VBN}}}
            child { node (np1) {\nt{NP}}
                child { node[xshift=-2.7cm] (np2) {\nt{NP}}
                    [sibling distance=8mm]
                    child { node[above=1mm of pos-1-1] {\nt{DT}}}
                    child { node[above=1mm of pos-1-2] {\nt{NN}}}}
                child { node (pp) {\nt{PP}}
                    child { node[above=1mm of pos-1-5] {\nt{IN}}}
                    child { node {\nt{NP}}
                        [sibling distance=7mm]
                        child { node[above=1mm of pos-1-6] {\nt{DT}}}
                        child { node[above=1mm of pos-1-7] {\nt{NN}}}}}}
            child { node[xshift=1.3cm] {\nt{NP}}
                child { node[above=1mm of pos-1-8] {\nt{NN}}}}};
    \end{tikzpicture}}
\newcommand{\ctreethree}{%
    \begin{tikzpicture}[
        font=\small,
        level distance=2.5em,
        edge from parent path={(\tikzparentnode.south) -- ++(0,-1mm) -| (\tikzchildnode.north)},
        anchor=center,
        every path/.style={line width=.2ex},
        every node/.style={text height=2.5mm},
        rounded corners=0
    ]
        \matrix (pos) [matrix of nodes, outer sep=0pt, inner sep=0pt, row sep=0pt, column sep=7pt, ampersand replacement=\&] {
            \strut What \& \strut should \& \strut I  \& \strut do \& \strut ? \\};
        \node[above=7.5em of pos, xshift=2em] {SBAR}
            child {node (SQ) {SQ}
                [sibling distance=2.5em]
                child { node (VP) {VP}
                    child { node[above=1mm of pos-1-1] (WP) {WP}}
                child  { node[above=1mm of pos-1-4] (VB) {VB}} }
                child { node[above=1mm of pos-1-2]  (MD){MD}}
                child { node[above=1mm of pos-1-3]  (PRP) {PRP}}}
            child { node[above=1mm of pos-1-5] {\$.}};
\end{tikzpicture}}

\tikzset{
    process/.style={draw, rectangle, inner sep=7px},
    boundingbox/.style={inner sep=0pt, outer sep=0pt},
    olabel/.style={gray, inner sep=0pt},
    obox/.style={draw, rectangle, rounded corners, line width=.3mm, align=left}
}

\begin{document}
    \begin{tikzpicture}[font=\small, node distance=1em]

    \node[olabel] (treebanklab) {treebank\strut};
    \begin{scope}[every node/.style={scale=0.3, obox}]
        \node[below=.3cm of treebanklab.west, anchor=north west, fill=black!40] (ctree1) {\ctreeone};
        \node[below right=-1.5cm of ctree1, fill=black!20] (ctree2) {\ctreetwo};
        \node[below right=-1.5cm of ctree2, fill=black!2] (ctree3) {\ctreethree};
    \end{scope}
    \node[fit=(treebanklab) (ctree1) (ctree3), boundingbox] (treebank) {};

    \node[right=1cm of treebank] (extraction) {\rotatebox{90}{extraction}};
    \coordinate (extractionboxn) at (treebank.north -| extraction);
    \coordinate (extractionboxs) at (treebank.south -| extraction);
    \node[process, fit=(extraction) (extractionboxn) (extractionboxs)] (extractionbox) {};

    \begin{scope}[every node/.style={obox, scale=0.51}]
        \node[right=1cm of extraction, fill=black!40] (rules1) {
            \(V^L \to[\text{where}][\ldots]\)\\
            \(\mathit{Root} \to [x_1\,\text{the}\,y_1\,x_2][\ldots] (V_2, N)\)\\
            \(N \to [\text{survey}] [\ldots]\)\\
            \(V_2 \to [x_1, \text{was}\, x_2] [\ldots] (V_2)\)\\
            \(V_2 \to [x_1, \text{carried}\, y_1] [\ldots](V^L, V^R)\)\\
            \(V^R \to [\text{out}][\ldots]\)
        };
        \node[below right=-1cm and -2cm of rules1, fill=black!20] (rules2) {
            \(V^L \to[\text{where}] [\ldots]\)\\
            \(\mathit{Root} \to [x_1\,\text{the}\,y_1\,x_2][\ldots] (V_2, N)\)\\
            \(N \to [\text{survey}] [\ldots]\)\\
            \(V_2 \to [x_1, \text{was}\, x_2][\ldots] (V_2)\)\\
            \(V_2 \to [x_1, \text{carried}\, y_1][\ldots] (V^L, V^R)\)\\
            \(V^R \to [\text{out}][\ldots]\)
        };
        \node[below right=-1cm and -2cm of rules2, fill=black!2] (rules3) {
            \(V^L \to[\text{What}] [\ldots]\)\\
            \(V_2 \to [x_1\,\text{do}][\ldots] (V^L)\)\\
            \(S \to [x_1\,\text{should}\,y_1\,x_2][\ldots](V^L, S^R)\)\\
            \(S^R \to [\text{I}][\ldots]\)\\
            \(\mathit{Root} \to [x_1\,?][\ldots] (S)\)
        };
    \end{scope}
    \node[olabel, anchor=west] (ruleslab) at (rules1.west |- treebanklab) {grammar rules\strut};
    \node[fit=(ruleslab) (rules1) (rules3), boundingbox] (rules) {};

    \node[right=1cm of rules] (mle) {\rotatebox{90}{mle}};
    \coordinate (mleboxn) at (treebank.north -| mle);
    \coordinate (mleboxs) at (treebank.south -| mle);
    \node[process, fit=(mle) (mleboxn) (mleboxs)] (mlebox) {};

    \node[right=1cm of mle, yshift=-3mm, fill=black!2, scale=0.65, obox] (grammar1) {
        \(\mathit{Root} \xrightarrow{0.2} [x_1\,\text{the}\,y_1\,x_2][\ldots] (V_2, N)\)\\
        \(\mathit{Root} \xrightarrow{0.15} [x_1\,\text{?}][\ldots] (S)\) \\
        \(\mathit{Root} \xrightarrow{0.35} [x_1\,\text{is}\,x_2][\ldots] (V_2)\) \\
        \(V^L \xrightarrow{0.1} [\text{where}][\ldots]\)\\
        \(V^L \xrightarrow{0.15} [\text{What}] [\ldots]\)\\
        \(\ldots\)
    };
    \node[olabel, anchor=west] (grammarlab) at (grammar1.west |- treebanklab) {weighted grammar\strut};
    \node[fit=(grammarlab) (grammar1), boundingbox] (grammar) {};


    \begin{scope}[every path/.style={dashed, gray, ->}, >=stealth]
        \draw (ctree1.30) -- (extractionbox.west|-ctree1.30);
        \draw (ctree2.30) -- (extractionbox.west|-ctree2.30);
        \draw (ctree3.30) -- (extractionbox.west|-ctree3.30);

        \draw (extractionbox.east|-rules1.-160) -- (rules1.-160);
        \draw (extractionbox.east|-rules2.-160) -- (rules2.-160);
        \draw (extractionbox.east|-rules3.-160) -- (rules3.-160);

        \draw (rules1.20) -- (mlebox.west|-rules1.20);
        \draw (rules2.20) -- (mlebox.west|-rules2.20);
        \draw (rules3.20) -- (mlebox.west|-rules3.20);

        \draw (mlebox.east|-grammar) -- (grammar.west);
    \end{scope}
    \end{tikzpicture}
\end{document}