\documentclass[../slides]{subfiles}

\begin{document}
    \begin{tikzpicture}[outer sep=0px, inner sep=1pt, >=stealth]
        \visible<10,12>{
            \begin{scope}[tcomp, level 2/.style={sibling distance=8ex}, level 3/.style={sibling distance=4ex}]
                \node (tvalroot) {SBAR}
                child {node {S}
                    child{ node {VP}
                        child {node[treeangle] (tvalleft) {}}
                        child {node[treeangle,fill=gray] {}}}
                    child{node {NP}
                        child {node{DT}
                            child {node (tvalthe) {the}}}
                        child {node[treeangle,fill=black] (tvalright) {}}}};
                \node[fit=(tvalroot) (tvalleft) (tvalright), inner sep=0pt, outer sep=0pt] (tval) {};
            \end{scope}
        }

        \visible<4,12>{
            \node[left=.5cm of tval.south west, font=\small, anchor=south east] (val) {$[$where the survey was carried out$]$};
        }

        \matrix[below=1cm of tval, xshift=-1cm] (rule) [matrix of nodes, ampersand replacement=\&] {
            \(\alert<2>{S}\) \& \(\to\) \& \alert<3-4>{$[\x_1 \, \text{the} \, \y_1 \, \x_2]$} \& \alert<9-10>{$\begin{bmatrix}\rootclause{}\end{bmatrix}$} \& $(\alert<2>{V_2}, \alert<2>{N})$\\
        };
        
        \visible<5-8>{
            \node[above=of rule-1-1] (fo1) {\(\mathrm{fo}(S) = 1\)};
            \node[right=of fo1] (fo2) {\(\mathrm{fo}(V_2) = 2\)};
            \node[right=of fo2] (fo3) {\(\mathrm{fo}(N) = 1\)};
        }

        \draw<6> (rule-1-3.north west) edge[decorate, decoration={brace}, gray] node[midway] (fobrace) {\phantom{a}} (rule-1-3.north east);
        \draw<6>[dashed, gray] (fobrace) edge[out=90, in=-90] (fo1);
        \draw<7>[dashed, gray] (rule-1-3.165) edge[out=90, in=-90] (fo2);
        \draw<7>[dashed, gray] (rule-1-3.20) edge[out=90, in=-90] (fo2);
        \draw<8>[dashed, gray] (rule-1-3.40) edge[out=90, in=-90] (fo3);

        \visible<3-4>{
            \matrix[below=1.2cm of rule-1-3, font=\small] (args) [matrix of nodes, ampersand replacement=\&] {
                $[$where, \& was carried out$]$, \& $[$survey$]$ \\
            };
            \draw<3-4>[dashed, gray] (args-1-1) edge[out=90, in=-90,->] (rule-1-3.-165);
            \draw<3-4>[dashed, gray] (args-1-2) edge[out=90, in=-90,->] (rule-1-3.-20);
            \draw<3-4>[dashed, gray] (args-1-3) edge[out=90, in=-90,->] (rule-1-3.-40);
        }
        \draw<4,12>[gray] (rule-1-3) edge[|->] (val.south);

        
        \visible<9-10>{
            \begin{scope}[tcomp]
                \node[below=1cm of rule-1-4, xshift=-.5cm] (targs-1-1) {VP}
                    child {node [treeangle]{}}
                    child {node[treeangle, fill=gray] {}};
                \node[below=1cm of rule-1-4, xshift=.5cm] (targs-1-2) {NP}
                    child {node {$\iparam$}}
                    child {node[treeangle, fill=black] {}};
            \end{scope}

            \draw<9-10>[dashed, gray] (targs-1-1) edge[out=90, in=-120,->] (rule-1-4);
            \draw<9-10>[dashed, gray] (targs-1-2) edge[out=90, in=-60,->] (rule-1-4);
        }
        \draw<10,12>[gray] (rule-1-4) edge[|->] (tval);

        \draw<11,12>[red] (rule-1-3.-120) edge[dashed, <->, out=-90, in=-90] node[below] {alignment} (rule-1-4.-70);
        \draw[red, visible on=<12>] (val.-170) edge[dashed, <->, out=-90, in=-90, looseness=.2] (tvalthe);

        \visible<13>{
            \matrix[below=2cm of rule-1-3, xshift=-1cm, ampersand replacement=\&, matrix of nodes, every node/.style={inner sep=0pt, outer sep=0pt, font=\strut\scriptsize}, column sep=5pt] (sntwhere) {where \& , \& was carried out\\ };
            \matrix[right=of sntwhere, ampersand replacement=\&, matrix of nodes, every node/.style={inner sep=0pt, outer sep=0pt, font=\strut\scriptsize}, column sep=5pt] (sntsurvey) {survey \\ };
            \matrix[above=1cm of rule-1-3, ampersand replacement=\&, matrix of nodes, every node/.style={inner sep=0pt, outer sep=0pt, font=\strut\scriptsize}, column sep=5pt] (sntresult) {where \& the \& survey \& was carried out\\ };
            \begin{scope}[tcomp]
                \node[above=4ex of sntwhere-1-2] (targ21) {VP}
                    child {node[treeangle, above=1.5ex of sntwhere-1-1] {}}
                    child {node[treeangle, above=1.5ex of sntwhere-1-3, fill=gray] {}};
                \node[above=4ex of sntsurvey, xshift=-1ex] (targ22) {NP}
                    child {node[treeangle, above=1.5ex of sntsurvey-1-1, fill=black] (sntsurvey-treeangle) {}}
                    child {node[left=of sntsurvey-treeangle, xshift=-2ex]{\iparam{}}};
                \node[above=11.5ex of sntresult-1-2] (tval2-0) {SBAR}
                    child {node {S}
                        child{ node[xshift=1.5] {VP}
                            child {node[treeangle, above=1.5ex of sntresult-1-1] (tval2-1) {}}
                            child {node[treeangle, above=1.5ex of sntresult-1-4, fill=gray] {}}}
                        child{node[yshift=-2.5ex] {NP}
                            child[color=black] {node[above=of sntresult-1-2.north]{DT}}
                            child[color=black] {node[treeangle, above=1.5ex of sntresult-1-3, fill=black] (tval2-2) {}}
                            edge from parent[double=black, color=white]}};
            \end{scope}
        }
        \node[fit=(tval2-0) (tval2-1) (tval2-2)] (tval2) {};
        \draw<13>[gray] (targ21)  edge[dashed, ->] (rule);
        \draw<13>[gray] (targ22)  edge[dashed, ->] (rule);
        \draw<13>[gray] (rule) edge[|->] (sntresult);
    \end{tikzpicture}
\end{document}